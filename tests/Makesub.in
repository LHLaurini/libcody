# CODYlib		-*- mode:Makefile -*-
# Copyright (C) 2019-2020 Nathan Sidwell, nathan@acm.org
# License: LGPL v3.0 or later

TESTS := $(patsubst $(srcdir)/%.cc,%,\
	$(wildcard $(srcdir)/tests/*/*.cc))

TESTDIRS = $(shell cd $(srcdir)/${<D} ; echo *(/))
ifneq (,$(filter joust,$(SUBPROJS)))
check: PATH := ../joust:$(PATH)
else
ifneq (./,$(dir $(firstword $(ALOY))))
check: PATH := $(dir $(firstword $(ALOY)))):$(PATH)
endif
endif

check:: tests/cody.defs $(TESTS)
	+cd ${<D} && srcbuilddir=$(srcdir)/tests JOUST=${<F} $(ALOY) -t kratos \
	  -o cody -g ../$(srcdir)/tests/jouster $(TESTDIRS)

tests/cody.defs: tests/Makesub
	echo '# Automatically generated by Make' >$@
	echo "srcdir=../${srcdir}/tests/" >>$@
	echo "timelimit=60" >>$@
	echo "memlimit=1" >>$@
	echo "cpulimit=60" >>$@
	echo "filelimit=1" >>$@
	echo "SHELL=$(SHELL)" >>$@

$(TESTS): %: %.o libcody.a
	$(CXX) $(LDFLAGS) $< -lcody $(LIBS) -o $@

clean::
	rm -f $(TESTS)
	rm -f $(TESTS:=.o) $(TESTS:=.d)

ifeq ($(filter clean%,$(MAKECMDGOALS)),)
-include $(TESTS:=.d)
endif
